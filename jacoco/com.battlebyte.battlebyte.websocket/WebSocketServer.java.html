<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebSocketServer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">BattleByte</a> &gt; <a href="index.source.html" class="el_package">com.battlebyte.battlebyte.websocket</a> &gt; <span class="el_source">WebSocketServer.java</span></div><h1>WebSocketServer.java</h1><pre class="source lang-java linenums">package com.battlebyte.battlebyte.websocket;

import com.battlebyte.battlebyte.config.BeanContext;
import com.battlebyte.battlebyte.entity.dto.UserGameDTO;
import com.battlebyte.battlebyte.entity.dto.UserProfileDTO;
import com.battlebyte.battlebyte.service.GameService;
import com.battlebyte.battlebyte.service.MatchService;
import com.battlebyte.battlebyte.service.OJService;
import com.battlebyte.battlebyte.service.UserService;
import com.battlebyte.battlebyte.service.match.Player;
import io.micrometer.common.util.StringUtils;
import jakarta.websocket.*;
import jakarta.websocket.server.PathParam;
import jakarta.websocket.server.ServerEndpoint;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.SynchronousQueue;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;

import static com.battlebyte.battlebyte.service.MatchService.removePlayer;
import static com.battlebyte.battlebyte.util.JwtUtil.getUserId;

@Component
@ServerEndpoint(&quot;/server&quot;)
<span class="fc" id="L37">@Slf4j</span>
public class WebSocketServer {

    /**
     * 记录当前在线连接数
     */
<span class="fc" id="L43">    private static int onlineCount = 0;</span>

    /**
     * 使用线程安全的ConcurrentHashMap来存放每个客户端对应的WebSocket对象
     */
<span class="fc" id="L48">    private static ConcurrentHashMap&lt;Integer, WebSocketServer&gt; webSocketMap = new ConcurrentHashMap&lt;&gt;();</span>
<span class="fc" id="L49">    private static ConcurrentHashMap&lt;Integer, CurrentGame&gt; currentGameMap = new ConcurrentHashMap&lt;&gt;();</span>

    /**
     * 与某个客户端的连接会话，需要通过它来给客户端发送数据
     */
    private Session session;

    /**
     * 接收客户端消息的uid
     */
<span class="fc" id="L59">    private Integer uid = 0;</span>
    /**
     * OJ服务
     */
<span class="fc" id="L63">    private OJService ojService = new OJService();</span>
    private GameService gameService;
    private UserService userService;

<span class="fc" id="L67">    public WebSocketServer() {</span>
<span class="fc" id="L68">        ojService = BeanContext.getApplicationContext().getBean(OJService.class);</span>
<span class="fc" id="L69">        gameService = BeanContext.getApplicationContext().getBean(GameService.class);</span>
<span class="fc" id="L70">        userService = BeanContext.getApplicationContext().getBean(UserService.class);</span>
<span class="fc" id="L71">    }</span>

    @OnOpen
    public void onOpen(Session session) {
<span class="nc" id="L75">    }</span>

    /**
     * 连接关闭调用的方法
     */
    @OnClose
    public void onClose() {
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (webSocketMap.containsKey(uid)) {</span>
<span class="nc" id="L83">            webSocketMap.remove(uid);</span>
            //取消匹配
<span class="nc" id="L85">            removePlayer(uid);</span>
            //从set中删除
<span class="nc" id="L87">            subOnlineCount();</span>
<span class="nc" id="L88">            log.info(&quot;用户【&quot; + uid + &quot;】退出，当前在线人数为:&quot; + getOnlineCount());</span>
        }
<span class="nc" id="L90">    }</span>

    /**
     * 收到客户端消息后调用的方法
     *
     * @param message 客户端发送过来的消息
     * @param session 会话
     */
    @OnMessage
    public void onMessage(String message, Session session) throws IOException {
        // 处理信息
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (StringUtils.isNotBlank(message)) {</span>
            try {
<span class="nc" id="L103">                log.info(&quot;Session【&quot; + session + &quot;】发送报文:&quot; + message);</span>

                //读取json文件
<span class="nc" id="L106">                JSONObject mssageObj = JSON.parseObject(message);</span>
<span class="nc" id="L107">                String type = mssageObj.getString(&quot;type&quot;);</span>
<span class="nc" id="L108">                JSONObject data = mssageObj.getJSONObject(&quot;data&quot;);</span>
<span class="nc" id="L109">                int id = mssageObj.getIntValue(&quot;id&quot;);</span>
                //设置session
<span class="nc" id="L111">                this.session = session;</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                if (type.equals(&quot;LOGIN_REQ&quot;)) {</span>
<span class="nc" id="L113">                    onMessage_LOGIN_REQ(data, id);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                } else if (type.equals(&quot;MATCH_REQ&quot;)) {</span>
<span class="nc" id="L115">                    onMessage_MATCH_REQ(data, id);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                } else if (type.equals(&quot;CHAT_REQ&quot;)) {</span>
<span class="nc" id="L117">                    onMessage_CHAT_REQ(data, id);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                } else if (type.equals(&quot;ANSWER_REFRESH&quot;)) {</span>
<span class="nc" id="L119">                    onMessage_ANSWER_REFRESH(data, id);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                } else if (type.equals(&quot;POS_UPDATE&quot;)) {</span>
<span class="nc" id="L121">                    onMessage_POS_UPDATE(data, id);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                } else if (type.equals(&quot;SURRENDER&quot;)) {</span>
<span class="nc" id="L123">                    onMessage_SURRENDER(data, id);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">                } else if (type.equals(&quot;ITEM_SEND&quot;)) {</span>
<span class="nc" id="L125">                    onMessage_ITEM_SEND(data, id);</span>
                }

<span class="nc" id="L128">            } catch (Exception e) {</span>
<span class="nc" id="L129">                log.error(&quot;用户【&quot; + uid + &quot;】发送消息异常！&quot;, e);</span>
<span class="nc" id="L130">            }</span>
        }
<span class="nc" id="L132">    }</span>

    //处理登录
    private void onMessage_LOGIN_REQ(JSONObject data, int id) throws IOException {
<span class="nc" id="L136">        String token = data.getString(&quot;token&quot;);</span>
<span class="nc" id="L137">        String filePath = &quot;/home/ubuntu&quot;;</span>
<span class="nc" id="L138">        File file = new File(filePath);</span>
        Integer uid;
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (file.exists()) {</span>
            //获取uid
<span class="nc" id="L142">            uid = getUserId(token);</span>
        } else {
            //获取uid 测试
<span class="nc" id="L145">            uid = Integer.valueOf(token);</span>
        }

<span class="nc" id="L148">        this.uid = uid;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (webSocketMap.containsKey(uid)) {</span>
            //断掉之前的
<span class="nc" id="L151">            WebSocketServer beforeSession = webSocketMap.get(uid);</span>
<span class="nc" id="L152">            beforeSession.getSession().close();</span>
<span class="nc" id="L153">            webSocketMap.remove(uid);</span>
        }
        //加入set中
<span class="nc" id="L156">        webSocketMap.put(uid, this);</span>
        //在线数加1
<span class="nc" id="L158">        addOnlineCount();</span>
<span class="nc" id="L159">        log.info(&quot;用户【&quot; + uid + &quot;】连接成功，当前在线人数为:&quot; + getOnlineCount());</span>
        try {
<span class="nc" id="L161">            JSONObject output_LOGIN_ACK = new JSONObject();</span>
<span class="nc" id="L162">            JSONObject dataOutput_LOGIN_ACK = new JSONObject();</span>

<span class="nc" id="L164">            dataOutput_LOGIN_ACK.put(&quot;code&quot;, 0);</span>

<span class="nc" id="L166">            output_LOGIN_ACK.put(&quot;type&quot;, &quot;LOGIN_ACK&quot;);</span>
<span class="nc" id="L167">            output_LOGIN_ACK.put(&quot;data&quot;, dataOutput_LOGIN_ACK);</span>
<span class="nc" id="L168">            sendMsg(output_LOGIN_ACK.toJSONString());</span>
<span class="nc" id="L169">        } catch (IOException e) {</span>
<span class="nc" id="L170">            log.error(&quot;用户【&quot; + uid + &quot;】网络异常!&quot;, e);</span>
<span class="nc" id="L171">        }</span>
        //如果上局比赛没结束
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (currentGameMap.containsKey(uid)) {</span>
<span class="nc" id="L174">            CurrentGame currentGame = currentGameMap.get(uid);</span>
<span class="nc" id="L175">            JSONObject output_MATCH_ENTER = new JSONObject();</span>
<span class="nc" id="L176">            JSONObject dataOutput_MATCH_ENTER = new JSONObject();</span>
<span class="nc" id="L177">            JSONObject infoOutput_MATCH_ENTER = new JSONObject();</span>

<span class="nc" id="L179">            infoOutput_MATCH_ENTER.put(&quot;questionId&quot;, currentGame.getQuestionId());</span>

<span class="nc" id="L181">            dataOutput_MATCH_ENTER.put(&quot;info&quot;, infoOutput_MATCH_ENTER);</span>
<span class="nc" id="L182">            dataOutput_MATCH_ENTER.put(&quot;playerMap&quot;, currentGame.getPlayerMap());</span>

<span class="nc" id="L184">            output_MATCH_ENTER.put(&quot;type&quot;, &quot;MATCH_ENTER&quot;);</span>
<span class="nc" id="L185">            output_MATCH_ENTER.put(&quot;data&quot;, dataOutput_MATCH_ENTER);</span>
            //webSocketMap.get(uid).sendMsg(output_MATCH_ENTER.toJSONString());
<span class="nc" id="L187">            sendMsg(uid, output_MATCH_ENTER.toJSONString());</span>
        }
<span class="nc" id="L189">    }</span>

    //处理匹配
    private void onMessage_MATCH_REQ(JSONObject data, int id) throws IOException {
<span class="nc" id="L193">        Integer type = data.getInteger(&quot;type&quot;);</span>

        //如果上局比赛没结束
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (currentGameMap.containsKey(uid)) {</span>
<span class="nc" id="L197">            JSONObject output = new JSONObject();</span>
<span class="nc" id="L198">            JSONObject dataOutput = new JSONObject();</span>

<span class="nc" id="L200">            dataOutput.put(&quot;ack&quot;, id);</span>
<span class="nc" id="L201">            dataOutput.put(&quot;msg&quot;, &quot;已在匹配对局中&quot;);</span>

<span class="nc" id="L203">            output.put(&quot;type&quot;, &quot;ERROR&quot;);</span>
<span class="nc" id="L204">            output.put(&quot;data&quot;, dataOutput);</span>

<span class="nc" id="L206">            sendMsg(output.toJSONString());</span>
<span class="nc" id="L207">        } else {</span>
            //todo:根据rating进行匹配


<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (type==1) {</span>
<span class="nc" id="L212">                MatchService.addPlayer1(uid, 1000);</span>
                //输出逻辑
<span class="nc" id="L214">                JSONObject output_MATCH_START = new JSONObject();</span>
<span class="nc" id="L215">                JSONObject dataOutput_MATCH_START = new JSONObject();</span>

<span class="nc" id="L217">                dataOutput_MATCH_START.put(&quot;type&quot;, type);</span>

<span class="nc" id="L219">                output_MATCH_START.put(&quot;type&quot;, &quot;MATCH_START&quot;);</span>
<span class="nc" id="L220">                output_MATCH_START.put(&quot;data&quot;, dataOutput_MATCH_START);</span>
<span class="nc" id="L221">                sendMsg(output_MATCH_START.toJSONString());</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            } else if (type==2) {</span>
<span class="nc" id="L223">                MatchService.addPlayer2(uid, 1000);</span>
                //输出逻辑
<span class="nc" id="L225">                JSONObject output_MATCH_START = new JSONObject();</span>
<span class="nc" id="L226">                JSONObject dataOutput_MATCH_START = new JSONObject();</span>

<span class="nc" id="L228">                dataOutput_MATCH_START.put(&quot;type&quot;, type);</span>

<span class="nc" id="L230">                output_MATCH_START.put(&quot;type&quot;, &quot;MATCH_START&quot;);</span>
<span class="nc" id="L231">                output_MATCH_START.put(&quot;data&quot;, dataOutput_MATCH_START);</span>
<span class="nc" id="L232">                sendMsg(output_MATCH_START.toJSONString());</span>
<span class="nc" id="L233">            } else {</span>
<span class="nc" id="L234">                JSONObject output = new JSONObject();</span>
<span class="nc" id="L235">                JSONObject dataOutput = new JSONObject();</span>

<span class="nc" id="L237">                dataOutput.put(&quot;ack&quot;, id);</span>
<span class="nc" id="L238">                dataOutput.put(&quot;msg&quot;, &quot;没有该游戏模式&quot;);</span>

<span class="nc" id="L240">                output.put(&quot;type&quot;, &quot;ERROR&quot;);</span>
<span class="nc" id="L241">                output.put(&quot;data&quot;, dataOutput);</span>

<span class="nc" id="L243">                sendMsg(output.toJSONString());</span>
            }

        }
<span class="nc" id="L247">    }</span>

    //匹配成功
    public static void return_MATCH_ENTER(int userId, int questionId, Map&lt;String, Integer&gt; playerMap, int gameId) throws IOException {
        //更新信息
        //输出逻辑
<span class="nc" id="L253">        JSONObject output_MATCH_ENTER = new JSONObject();</span>
<span class="nc" id="L254">        JSONObject dataOutput_MATCH_ENTER = new JSONObject();</span>
<span class="nc" id="L255">        JSONObject infoOutput_MATCH_ENTER = new JSONObject();</span>

<span class="nc" id="L257">        infoOutput_MATCH_ENTER.put(&quot;questionId&quot;, questionId);</span>

<span class="nc" id="L259">        dataOutput_MATCH_ENTER.put(&quot;info&quot;, infoOutput_MATCH_ENTER);</span>
<span class="nc" id="L260">        dataOutput_MATCH_ENTER.put(&quot;playerMap&quot;, playerMap);</span>

<span class="nc" id="L262">        output_MATCH_ENTER.put(&quot;type&quot;, &quot;MATCH_ENTER&quot;);</span>
<span class="nc" id="L263">        output_MATCH_ENTER.put(&quot;data&quot;, dataOutput_MATCH_ENTER);</span>
<span class="nc" id="L264">        webSocketMap.get(userId).sendMsg(output_MATCH_ENTER.toJSONString());</span>

        //更新当前比赛信息
<span class="nc" id="L267">        CurrentGame currentGame = new CurrentGame();</span>
<span class="nc" id="L268">        currentGame.setGameId(gameId);</span>
<span class="nc" id="L269">        currentGame.setQuestionId(questionId);</span>
<span class="nc" id="L270">        currentGame.setPlayerMap(playerMap);</span>
<span class="nc" id="L271">        currentGameMap.put(userId, currentGame);</span>
<span class="nc" id="L272">    }</span>

    // 处理聊天
    private void onMessage_CHAT_REQ(JSONObject data, int id) throws IOException {
        //读取json文件
<span class="nc" id="L277">        String type = data.getString(&quot;type&quot;);</span>
<span class="nc" id="L278">        String message = data.getString(&quot;message&quot;);</span>

        //获取同局人员
<span class="nc" id="L281">        Integer gameId = currentGameMap.get(uid).getGameId();</span>
<span class="nc" id="L282">        List&lt;UserGameDTO&gt; players = gameService.getPlayer(gameId);</span>
        //获取当前uid的队号
<span class="nc" id="L284">        int teamId = 0;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">        for (UserGameDTO userGameDTO : players) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (userGameDTO.getId() == uid) {</span>
<span class="nc" id="L287">                teamId = userGameDTO.getTeam();</span>
<span class="nc" id="L288">                break;</span>
            }
<span class="nc" id="L290">        }</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (type.equals(&quot;team&quot;)) { //队内聊天</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">            for (UserGameDTO userGameDTO : players) {</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">                if (userGameDTO.getTeam() == teamId) { //如果是同队的</span>
                    //输出逻辑
<span class="nc" id="L295">                    JSONObject output = new JSONObject();</span>
<span class="nc" id="L296">                    JSONObject dataOutput = new JSONObject();</span>

                    //通过uid读取名字
<span class="nc" id="L299">                    UserProfileDTO userProfileDTO = userService.findByUserId(uid);</span>

<span class="nc" id="L301">                    dataOutput.put(&quot;fromName&quot;, userProfileDTO.getUserName());</span>
<span class="nc" id="L302">                    dataOutput.put(&quot;fromId&quot;, uid);</span>
<span class="nc" id="L303">                    dataOutput.put(&quot;message&quot;, message);</span>

<span class="nc" id="L305">                    output.put(&quot;type&quot;, &quot;CHAT_MSG&quot;);</span>
<span class="nc" id="L306">                    output.put(&quot;data&quot;, dataOutput);</span>
                    //webSocketMap.get(userGameDTO.getId()).sendMsg(output.toJSONString());
<span class="nc" id="L308">                    sendMsg(userGameDTO.getId(), output.toJSONString());</span>
                }
<span class="nc" id="L310">            }</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">        } else if (type.equals(&quot;global&quot;)) { //全局聊天</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            for (UserGameDTO userGameDTO : players) {</span>
                //输出逻辑
<span class="nc" id="L314">                JSONObject output = new JSONObject();</span>
<span class="nc" id="L315">                JSONObject dataOutput = new JSONObject();</span>

                //通过uid读取名字
<span class="nc" id="L318">                UserProfileDTO userProfileDTO = userService.findByUserId(uid);</span>

<span class="nc" id="L320">                dataOutput.put(&quot;fromName&quot;, userProfileDTO.getUserName());</span>
<span class="nc" id="L321">                dataOutput.put(&quot;fromId&quot;, uid);</span>
<span class="nc" id="L322">                dataOutput.put(&quot;message&quot;, message);</span>

<span class="nc" id="L324">                output.put(&quot;type&quot;, &quot;CHAT_MSG&quot;);</span>
<span class="nc" id="L325">                output.put(&quot;data&quot;, dataOutput);</span>
                //webSocketMap.get(userGameDTO.getId()).sendMsg(output.toJSONString());
<span class="nc" id="L327">                sendMsg(userGameDTO.getId(), output.toJSONString());</span>
<span class="nc" id="L328">            }</span>
        }
<span class="nc" id="L330">    }</span>

    // 刷新评测结果
    private void onMessage_ANSWER_REFRESH(JSONObject data, int id) throws IOException {
<span class="nc" id="L334">        String submit_id = data.getString(&quot;submit_id&quot;);</span>

        //输出逻辑
<span class="nc" id="L337">        JSONObject output = new JSONObject();</span>
<span class="nc" id="L338">        JSONObject dataOutput = new JSONObject();</span>
<span class="nc" id="L339">        JSONObject result = ojService.getResult(submit_id);</span>

<span class="nc" id="L341">        dataOutput.put(&quot;result&quot;, result);</span>
<span class="nc" id="L342">        output.put(&quot;type&quot;, &quot;ANSWER_RESULT&quot;);</span>
<span class="nc" id="L343">        output.put(&quot;data&quot;, dataOutput);</span>
<span class="nc" id="L344">        sendMsg(output.toJSONString());</span>

        //判断是否结束
<span class="nc" id="L347">        JSONObject dataResult = result.getJSONObject(&quot;data&quot;);</span>
<span class="nc" id="L348">        JSONObject statistic_info = dataResult.getJSONObject(&quot;statistic_info&quot;);</span>
<span class="nc" id="L349">        JSONObject info = dataResult.getJSONObject(&quot;info&quot;);</span>
        //已评测完
<span class="nc bnc" id="L351" title="All 4 branches missed.">        if (!(info.isEmpty() &amp;&amp; statistic_info.isEmpty())) {</span>
            //已结束
<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (dataResult.getInteger(&quot;result&quot;) == 0) {</span>
<span class="nc" id="L354">                Integer gameId = currentGameMap.get(uid).getGameId();</span>
<span class="nc" id="L355">                List&lt;UserGameDTO&gt; players = gameService.getPlayer(gameId);</span>
                //获取赢的队伍
<span class="nc" id="L357">                int winTeamId = 0;</span>
                //todo:多人模式记得修改这部分逻辑
<span class="nc bnc" id="L359" title="All 2 branches missed.">                for (UserGameDTO userGameDTO : players) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                    if (userGameDTO.getId() == uid) {</span>
<span class="nc" id="L361">                        winTeamId = userGameDTO.getTeam();</span>
<span class="nc" id="L362">                        break;</span>
                    }
<span class="nc" id="L364">                }</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">                for (UserGameDTO userGameDTO : players) {</span>
                    //如果是赢
<span class="nc bnc" id="L367" title="All 2 branches missed.">                    if (userGameDTO.getTeam() == winTeamId) {</span>
<span class="nc" id="L368">                        returnGameEnd(userGameDTO.getId(), &quot;win&quot;);</span>
                    } else {//假如是输
<span class="nc" id="L370">                        returnGameEnd(userGameDTO.getId(), &quot;lose&quot;);</span>
                    }
                    //清楚当前比赛
<span class="nc" id="L373">                    currentGameMap.remove(userGameDTO.getId());</span>
<span class="nc" id="L374">                }</span>
            }
        }
<span class="nc" id="L377">    }</span>

    public void returnGameEnd(int userId, String result) throws IOException {
<span class="nc" id="L380">        JSONObject output = new JSONObject();</span>
<span class="nc" id="L381">        JSONObject dataOutput = new JSONObject();</span>

<span class="nc" id="L383">        dataOutput.put(&quot;result&quot;, result);</span>
<span class="nc" id="L384">        output.put(&quot;type&quot;, &quot;GAME_END&quot;);</span>
<span class="nc" id="L385">        output.put(&quot;data&quot;, dataOutput);</span>

        //webSocketMap.get(userId).sendMsg(output.toJSONString());
<span class="nc" id="L388">        sendMsg(userId, output.toJSONString());</span>
<span class="nc" id="L389">    }</span>

    //处理光标移动
    private void onMessage_POS_UPDATE(JSONObject data, int id) throws IOException {
<span class="nc" id="L393">        int row = data.getInteger(&quot;row&quot;);</span>
<span class="nc" id="L394">        int col = data.getInteger(&quot;col&quot;);</span>
<span class="nc" id="L395">        int total_rows = data.getInteger(&quot;total_rows&quot;);</span>

        //获取同局人员
<span class="nc" id="L398">        Integer gameId = currentGameMap.get(uid).getGameId();</span>
<span class="nc" id="L399">        List&lt;UserGameDTO&gt; players = gameService.getPlayer(gameId);</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">        for (UserGameDTO userGameDTO : players) {</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">            if (userGameDTO.getId() != uid) {</span>
                //输出逻辑
<span class="nc" id="L404">                JSONObject output = new JSONObject();</span>
<span class="nc" id="L405">                JSONObject dataOutput = new JSONObject();</span>

<span class="nc" id="L407">                dataOutput.put(&quot;row&quot;, row);</span>
<span class="nc" id="L408">                dataOutput.put(&quot;col&quot;, col);</span>
<span class="nc" id="L409">                dataOutput.put(&quot;total_rows&quot;, total_rows);</span>
<span class="nc" id="L410">                dataOutput.put(&quot;user_id&quot;, uid);</span>

<span class="nc" id="L412">                output.put(&quot;type&quot;, &quot;POS_SYNC&quot;);</span>
<span class="nc" id="L413">                output.put(&quot;data&quot;, dataOutput);</span>
                //webSocketMap.get(userGameDTO.getId()).sendMsg(output.toJSONString());
<span class="nc" id="L415">                sendMsg(userGameDTO.getId(), output.toJSONString());</span>
            }
<span class="nc" id="L417">        }</span>
<span class="nc" id="L418">    }</span>

    public void onMessage_SURRENDER(JSONObject data, int id) throws IOException {
<span class="nc" id="L421">        Integer gameId = currentGameMap.get(uid).getGameId();</span>
<span class="nc" id="L422">        List&lt;UserGameDTO&gt; players = gameService.getPlayer(gameId);</span>
        //获取赢的队伍
<span class="nc" id="L424">        int surrenderTeamId = 0;</span>
        //todo:多人模式记得修改这部分逻辑
<span class="nc bnc" id="L426" title="All 2 branches missed.">        for (UserGameDTO userGameDTO : players) {</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">            if (userGameDTO.getId() == uid) {</span>
<span class="nc" id="L428">                surrenderTeamId = userGameDTO.getTeam();</span>
<span class="nc" id="L429">                break;</span>
            }
<span class="nc" id="L431">        }</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        for (UserGameDTO userGameDTO : players) {</span>
            //如果是赢
<span class="nc bnc" id="L434" title="All 2 branches missed.">            if (userGameDTO.getTeam() == surrenderTeamId) {</span>
<span class="nc" id="L435">                returnGameEnd(userGameDTO.getId(), &quot;lose&quot;);</span>
            } else {//假如是输
<span class="nc" id="L437">                returnGameEnd(userGameDTO.getId(), &quot;win&quot;);</span>
            }
            //清楚当前比赛
<span class="nc" id="L440">            currentGameMap.remove(userGameDTO.getId());</span>
<span class="nc" id="L441">        }</span>
<span class="nc" id="L442">    }</span>

    //处理道具
    private void onMessage_ITEM_SEND(JSONObject data, int id) throws IOException {
        //读取json文件
<span class="nc" id="L447">        String type = data.getString(&quot;type&quot;);</span>

        //获取同局人员
<span class="nc" id="L450">        Integer gameId = currentGameMap.get(uid).getGameId();</span>
<span class="nc" id="L451">        List&lt;UserGameDTO&gt; players = gameService.getPlayer(gameId);</span>
        //获取当前uid的队号
<span class="nc" id="L453">        int teamId = 0;</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">        for (UserGameDTO userGameDTO : players) {</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">            if (userGameDTO.getId() == uid) {</span>
<span class="nc" id="L456">                teamId = userGameDTO.getTeam();</span>
<span class="nc" id="L457">                break;</span>
            }
<span class="nc" id="L459">        }</span>

<span class="nc bnc" id="L461" title="All 2 branches missed.">        for (UserGameDTO userGameDTO : players) {</span>
            //如果不同队
<span class="nc bnc" id="L463" title="All 2 branches missed.">            if (userGameDTO.getTeam() != teamId) {</span>
                //输出逻辑
<span class="nc" id="L465">                JSONObject output = new JSONObject();</span>
<span class="nc" id="L466">                JSONObject dataOutput = new JSONObject();</span>
<span class="nc" id="L467">                dataOutput.put(&quot;type&quot;, type);</span>

<span class="nc" id="L469">                output.put(&quot;type&quot;, &quot;ITEM_USED&quot;);</span>
<span class="nc" id="L470">                output.put(&quot;data&quot;, dataOutput);</span>

<span class="nc" id="L472">                sendMsg(userGameDTO.getId(), output.toJSONString());</span>
            }
<span class="nc" id="L474">        }</span>

<span class="nc" id="L476">    }</span>

    @OnError
    public void onError(Session session, Throwable error) {
<span class="nc" id="L480">        log.error(&quot;用户【&quot; + this.uid + &quot;】处理消息错误，原因:&quot; + error.getMessage());</span>
<span class="nc" id="L481">        error.printStackTrace();</span>
<span class="nc" id="L482">    }</span>

    /**
     * 实现服务器主动推送
     *
     * @param msg
     * @throws IOException
     */
    private void sendMsg(String msg) throws IOException {
<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (this.session != null)</span>
<span class="nc" id="L492">            this.session.getBasicRemote().sendText(msg);</span>
        else
<span class="nc" id="L494">            System.out.println(&quot;no session here&quot;);</span>
<span class="nc" id="L495">    }</span>

    private void sendMsg(int uid, String msg) throws IOException {
<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (webSocketMap.containsKey(uid))</span>
<span class="nc" id="L499">            webSocketMap.get(uid).session.getBasicRemote().sendText(msg);</span>
        else
<span class="nc" id="L501">            System.out.println(&quot;no session here&quot;);</span>
<span class="nc" id="L502">    }</span>

    public Session getSession() {
<span class="nc" id="L505">        return this.session;</span>
    }

    /**
     * 发送自定义消息
     *
     * @param message
     * @param uid
     * @throws IOException
     */
    public static void sendInfo(String message, @PathParam(&quot;uid&quot;) String uid) throws IOException {
<span class="nc" id="L516">        log.info(&quot;发送消息到用户【&quot; + uid + &quot;】发送的报文:&quot; + message);</span>
<span class="nc bnc" id="L517" title="All 4 branches missed.">        if (!StringUtils.isEmpty(uid) &amp;&amp; webSocketMap.containsKey(uid)) {</span>
<span class="nc" id="L518">            webSocketMap.get(uid).sendMsg(message);</span>
        } else {
<span class="nc" id="L520">            log.error(&quot;用户【&quot; + uid + &quot;】不在线！&quot;);</span>
        }
<span class="nc" id="L522">    }</span>

    public static synchronized int getCurrentMatch() {
<span class="nc" id="L525">        return MatchService.matchingPool.getCurrentMatch();</span>
    }

    public static synchronized int getOnlineCount() {
<span class="nc" id="L529">        return onlineCount;</span>
    }

    private static synchronized void addOnlineCount() {
<span class="nc" id="L533">        WebSocketServer.onlineCount++;</span>
<span class="nc" id="L534">    }</span>

    private static synchronized void subOnlineCount() {
<span class="nc" id="L537">        WebSocketServer.onlineCount--;</span>
<span class="nc" id="L538">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>